<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.scm.calculate.repository.CalculateMapper">
    <select id="getVslCodeList" resultType="VslCodeDto">
        select
            vsl_cd, vsl_nm, vsl_dead_wt, vsl_load_posbl_wt
        from
            tcom.tb_vsl_info
    </select>
    <select id="getSettleInfoList" resultType="CalculateInfoDto">
        select
            p.acctg_yn, p.vsl_load_posbl_wt * 1000 as vsl_load_posbl_wt, p.cd_v_meaning as nation_nm, p.lsp_id, tcd.cd_v_meaning,
            p.vsl_cd, p.vsl_nm,
            p.trans_order_no, p.close_no_yn,
            p.clear_curr, p.bl_date, SUM(p.clear_qty) as clear_qty, ROUND(SUM(p.clear_amt)::numeric,2) as clear_amt,
            SUM(p.tot_gross_wt) as tot_gross_wt, ROUND(SUM(p.acctg_amt)::numeric,2) as acctg_amt
        from
        (
            select
                k.acctg_yn, k.lsp_id, w.cd_v_meaning,
                k.vsl_cd , k.vsl_nm ,
                k.trans_order_no , k.close_no_yn ,
                k.clear_curr , k.clear_qty , k.clear_amt ,
                k.acctg_amt, k.bl_date, k.tot_gross_wt, k.vsl_load_posbl_wt
            from
            (
                select
                    tvi.vsl_load_posbl_wt, b.vsl_cd, b.vsl_nm,  b.trans_order_no
                    , b.lsp_id, a.close_no_yn, a.clear_curr
                    , b.clear_qty, a.clear_amt, a.acctg_amt, a.acctg_yn
                    , a.bl_date, c.delivery_area_cd, b.tot_gross_wt
                from
                    tbms.tb_fri_settle_info a
                join
                    tbms.tb_fri_settle_h b
                on
                    a.inv_inner_no  = b.inv_inner_no
                and
                    a.inv_inner_seq_no = b.inv_inner_seq_no
                join
                    tcom.tb_dest_info c
                on
                    a.arr_node_cd = c.node_cd
                join
                    tcom.tb_vsl_info tvi
                on
                    b.vsl_cd = tvi.vsl_cd
                ) k
            join
                tcom.tb_code_definition w
            on
                k.delivery_area_cd = w.cd_v
        ) p
        join
            tcom.tb_code_definition tcd
        on
            p.lsp_id = tcd.cd_v
        where
        <choose>
            <when test="startDate!=null&amp;&amp;startDate!=''" >
                    p.bl_date <![CDATA[>=]]> #{startDate}
                AND
                    p.bl_date <![CDATA[<=]]> #{endDate}
            </when>
            <otherwise>
                    p.bl_date LIKE CONCAT('%', #{startDate}, '%')
            </otherwise>
        </choose>
        AND
            p.lsp_id  LIKE CONCAT('%', #{lspId}, '%')
        AND
            p.vsl_cd  LIKE CONCAT('%', #{vslCd}, '%')
        AND
            p.close_no_yn  LIKE CONCAT('%', #{closeNoYn}, '%')
        AND
            p.trans_order_no LIKE CONCAT('%', #{transOrderNo}, '%')
        AND
            p.cd_v_meaning  LIKE CONCAT('%', #{cdVmeaning}, '%')
        group by
            p.trans_order_no, p.cd_v_meaning, p.lsp_id, tcd.cd_v_meaning,
            p.vsl_cd, p.vsl_nm,
            p.trans_order_no, p.close_no_yn, p.vsl_load_posbl_wt,
            p.clear_curr, p.acctg_yn, p.bl_date
    </select>
    <select id="getCalculateDetailList" resultType="CalculateInfoDto">
        select
            p.inv_inner_no, p.inv_inner_seq_no, p.item_cd, p.local_supp_amt, p.local_curr_cd, p.local_exr, p.unit_price, p.tot_gross_wt_unit_cd,
            p.fac_cd, p.arr_node_nm, p.ref_doc_no, p.cd_v_meaning as nation_nm, p.lsp_id, tcd.cd_v_meaning,
            p.vsl_cd, p.vsl_nm, p.trans_order_no, p.close_no_yn,
            p.clear_curr, p.bl_date, p.clear_qty as clear_qty, p.clear_amt as clear_amt,
            p.tot_gross_wt as tot_gross_wt, p.acctg_amt as acctg_amt
        from
        (
            select
                k.inv_inner_seq_no, k.item_cd, k.local_supp_amt, k.local_curr_cd, k.local_exr, k.unit_price, k.tot_gross_wt_unit_cd, k.fac_cd, k.ref_doc_no,k.arr_node_nm, k.acctg_yn, k.lsp_id, w.cd_v_meaning,
                k.vsl_cd , k.vsl_nm ,
                k.trans_order_no , k.close_no_yn ,
                k.clear_curr , k.clear_qty , k.clear_amt ,
                k.acctg_amt, k.bl_date, k.tot_gross_wt, k.inv_inner_no
            from
                (
                select
                    b.inv_inner_seq_no, b.item_cd, a.local_supp_amt, a.local_curr_cd, a.local_exr, a.unit_price, b.tot_gross_wt_unit_cd, b.fac_cd, b.ref_doc_no,a.arr_node_nm,  a.inv_inner_no,b.vsl_cd, b.vsl_nm,  b.trans_order_no
                    , b.lsp_id, a.close_no_yn, a.clear_curr
                    , b.clear_qty, a.clear_amt, a.acctg_amt, a.acctg_yn
                    , a.bl_date, c.delivery_area_cd, b.tot_gross_wt
                from
                    tbms.tb_fri_settle_info a
                join
                    tbms.tb_fri_settle_h b
                on
                    a.inv_inner_no  = b.inv_inner_no
                and
                    a.inv_inner_seq_no = b.inv_inner_seq_no
                join
                    tcom.tb_dest_info c
                on
                    a.arr_node_cd = c.node_cd
                ) k
        join
            tcom.tb_code_definition w
        on
            k.delivery_area_cd = w.cd_v
        ) p
        join
            tcom.tb_code_definition tcd
        on
            p.lsp_id = tcd.cd_v
        where
            p.trans_order_no  = #{transOrderNo}
        order by
            p.inv_inner_seq_no
    </select>
</mapper>